<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=0.8">
    <title>Manhattan Speed Map</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        header {
            background-color: #f4f4f4;
            padding: 20px;
            text-align: center;
        }
        #main-content {
            display: flex;
            flex: 1;
            padding: 20px;
        }
        #controls-container {
            flex: 1;
            margin-right: 20px;
        }
        #map {
            width: 100%;
            height: 500px;
        }
        #controls {
            margin-bottom: 20px;
            text-align: center;
        }
        #description {
            margin-bottom: 20px;
            text-align: center;
        }
        #legend {
            padding: 10px;
            border: 1px solid #ddd;
            background-color: #f9f9f9;
            font-size: 14px;
            width: 200px;
        }
        .legend-item {
            display: flex;
            align-items: left;
            margin-bottom: 20px;
        }
        .legend-color {
            width: 20px;
            height: 20px;
            margin-right: 10px;
        }
        h3 {
            margin-top: 0;
            font-size: 16px;
        }
    </style>
    <script src="https://api.tomtom.com/maps-sdk-for-web/cdn/6.x/6.25.0/maps/maps-web.min.js"></script>
</head>
<body>
<header>
    <h1>Manhattan Speed Map</h1>
    <p>This map shows speed data from each hour of October 1st 2022. Choose from average speed, median speed, and harmonic speed. </p>
    <p>Resources: This map is generated by Tom Tom and all data is from Tom Tom Moves. HTML and code styling was done using Chat GPT 4.</p>
</header>

<div id="main-content">
    <!-- Controls and Description -->
    <div id="controls-container">

        <label for="timeSelector">Select Time:</label>
        <select id="timeSelector">
            <option value="12am">12 AM</option>
            <option value="1am">1 AM</option>
            <option value="2am">2 AM</option>
            <option value="3am">3 AM</option>
            <option value="4am">4 AM</option>
            <option value="5am">5 AM</option>
            <option value="6am">6 AM</option>
            <option value="7am">7 AM</option>
            <option value="8am">8 AM</option>
            <option value="9am">9 AM</option>
            <option value="10am">10 AM</option>
            <option value="11am">11 AM</option>
            <option value="12pm">12 PM</option>
            <option value="1pm">1 PM</option>
            <option value="2pm">2 PM</option>
            <option value="3pm">3 PM</option>
            <option value="4pm">4 PM</option>
            <option value="5pm">5 PM</option>
            <option value="6pm">6 PM</option>
            <option value="7pm">7 PM</option>
            <option value="8pm">8 PM</option>
            <option value="9pm">9 PM</option>
            <option value="10pm">10 PM</option>
            <option value="11pm">11 PM</option>
        </select>

        <p ></p>


            <label for="speedTypeSelector">Select Speed Type:</label>
            <select id="speedTypeSelector">
                <option value="averageSpeed">Average Speed</option>
                <option value="harmonicAverageSpeed">Harmonic Average Speed</option>
                <option value="medianSpeed">Median Speed</option>
            </select>

        <p id="speedDescription">Average speed: the overall average speed of vehicles on the road.</p>

    </div>

    <p ></p>

    <!-- Legend for the speed colors -->
    <div id="legend">
        <h3>Corresponding Speeds and Colors</h3>
        <div class="legend-item">
            <div class="legend-color" style="background-color: red;"></div>
            <span>0-20 km/h</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: orange;"></div>
            <span>20-30 km/h</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: yellow;"></div>
            <span>30-40 km/h</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: green;"></div>
            <span>40+ km/h</span>
        </div>
    </div>
</div>

<div id="map"></div>

<script>
    var apiKey = 'vN40OGAlAyDZAzQQuMOzaUhkjVYG5WfG';
    var map = tt.map({
        key: apiKey,
        container: 'map',
        center: [-74.0060, 40.7128],
        zoom: 12
    });

    var currentLayer = null;
    var currentSource = null;

    // Speed type descriptions
    var speedDescriptions = {
        'averageSpeed': 'Average speed: the overall average speed of vehicles on the road.',
        'harmonicAverageSpeed': 'Harmonic Average Speed: the inverse of the average of the inverse speeds.',
        'medianSpeed': 'Median speed: the speed at or below which 50% of the vehicles were observed to travel.'
    };

    function updateDescription(time, speedType) {
        // Update the speed type description
        var speedDescription = document.getElementById('speedDescription');
        speedDescription.textContent = speedDescriptions[speedType];
    }

    function loadGeoJSON(time, speedType) {
        fetch(time + '.geojson')
            .then(response => response.json())
            .then(data => {
                console.log('GeoJSON Data:', data);

                // Filter out features with null geometry
                data.features = data.features.filter(feature => feature.geometry !== null);

                // Iterate over the features to set the selected speed type
                data.features.forEach(feature => {
                    if (feature.properties.segmentTimeResults && feature.properties.segmentTimeResults.length > 0) {
                        var selectedSpeed = feature.properties.segmentTimeResults[0][speedType];
                        feature.properties.selectedSpeed = (selectedSpeed !== null && !isNaN(selectedSpeed)) ? selectedSpeed : 0;
                    } else {
                        feature.properties.selectedSpeed = 0; // Assign 0 if no valid speed value is found
                    }
                });

                // Remove the existing layer and source if they exist
                if (currentLayer && map.getLayer(currentLayer)) {
                    map.removeLayer(currentLayer);
                }
                if (currentSource && map.getSource(currentSource)) {
                    map.removeSource(currentSource);
                }

                // Add new source and layer for the selected time and speed type
                currentSource = 'roadSegments_' + time + '_' + speedType;
                currentLayer = 'roadSegmentsLayer_' + time + '_' + speedType;

                map.addSource(currentSource, {
                    'type': 'geojson',
                    'data': data
                });

                map.addLayer({
                    'id': currentLayer,
                    'type': 'line',
                    'source': currentSource,
                    'paint': {
                        'line-color': [
                            'case',
                            ['==', ['get', 'selectedSpeed'], 0], 'gray', // Use gray for 0 or invalid speeds
                            ['>=', ['get', 'selectedSpeed'], 40], 'green',
                            ['>=', ['get', 'selectedSpeed'], 30], 'yellow',
                            ['>=', ['get', 'selectedSpeed'], 20], 'orange',
                            'red'
                        ],
                        'line-width': 4
                    }
                });
            })
            .catch(error => console.error('Error loading GeoJSON:', error));
    }

    // Initial load with default values
    loadGeoJSON('12am', 'averageSpeed');
    updateDescription('12am', 'averageSpeed');

    // Event listener for the time dropdown menu
    document.getElementById('timeSelector').addEventListener('change', function() {
        var selectedTime = this.value;
        var selectedSpeedType = document.getElementById('speedTypeSelector').value;
        loadGeoJSON(selectedTime, selectedSpeedType);
        updateDescription(selectedTime, selectedSpeedType);
    });

    // Event listener for the speed type dropdown menu
    document.getElementById('speedTypeSelector').addEventListener('change', function() {
        var selectedSpeedType = this.value;
        var selectedTime = document.getElementById('timeSelector').value;
        loadGeoJSON(selectedTime, selectedSpeedType);
        updateDescription(selectedTime, selectedSpeedType);
    });
</script>
</body>
</html>
